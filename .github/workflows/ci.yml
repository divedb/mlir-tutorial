name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint markdown files
        uses: DavidAnson/markdownlint-cli2-action@v15
        with:
          globs: '**/*.md'

  validate-mlir:
    name: Validate MLIR Examples
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install LLVM/MLIR
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 18
          sudo apt-get install -y llvm-18-tools mlir-18-tools

      - name: Add LLVM to PATH
        run: |
          echo "/usr/lib/llvm-18/bin" >> $GITHUB_PATH

      - name: Verify mlir-opt installation
        run: |
          which mlir-opt-18 || echo "mlir-opt-18 not found in PATH"
          ls -la /usr/lib/llvm-18/bin/ || echo "LLVM bin directory not found"

      - name: Validate MLIR files
        run: |
          echo "Validating MLIR examples..."
          EXIT_CODE=0
          for file in $(find examples -name "*.mlir"); do
            echo "Checking $file..."
            if mlir-opt-18 "$file" --verify-diagnostics > /dev/null 2>&1; then
              echo "✓ $file is valid"
            else
              echo "✗ $file has errors"
              mlir-opt-18 "$file" --verify-diagnostics || true
              EXIT_CODE=1
            fi
          done
          exit $EXIT_CODE

  check-structure:
    name: Check Repository Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify required files
        run: |
          echo "Checking for required files..."
          
          # Check for essential files
          test -f README.md || { echo "Missing README.md"; exit 1; }
          test -f LICENSE || { echo "Missing LICENSE"; exit 1; }
          test -f CONTRIBUTING.md || { echo "Missing CONTRIBUTING.md"; exit 1; }
          test -f .gitignore || { echo "Missing .gitignore"; exit 1; }
          
          # Check for docs directory
          test -d docs || { echo "Missing docs directory"; exit 1; }
          
          # Check for examples directory
          test -d examples || { echo "Missing examples directory"; exit 1; }
          
          echo "✓ All required files and directories present"

      - name: Check for broken links in README
        run: |
          echo "Checking README structure..."
          grep -q "## What is MLIR?" README.md || { echo "Missing MLIR intro section"; exit 1; }
          grep -q "## Installation" README.md || { echo "Missing installation section"; exit 1; }
          grep -q "## Examples" README.md || { echo "Missing examples section"; exit 1; }
          echo "✓ README structure is valid"
